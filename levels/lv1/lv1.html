<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>BlockAr - Nivel 1</title>             
    <link rel="stylesheet" href="../../styles/style_levels.css">
    <script src="../../js/acorn_interpreter.js"></script>    
    <!-- Se carga el espacio de trabajo de tamaño fijo -->
    <script src="../../node_modules/blockly/blockly_compressed.js"></script>
    <script src="../../node_modules/blockly/blocks_compressed.js"></script>
    <!-- Se carga generador de código para javascript-->
    <script src="../../node_modules/blockly/javascript_compressed.js"></script>
    <!-- Se carga el idioma de los bloques -->
    <script src="../../node_modules/blockly/msg/es.js"></script>   
    <!-- Seteo los movimientos a traves de los bloques --> 
    <script src="../../js/movement_block.js"></script>
    <script src="../../js/movement_stub.js"></script>

    <script src="../../node_modules/phaser/dist/phaser.js"></script>    
    <!-- Declaro el javascript que contiene la inicialización de blockly -->
    <script src="../../js/init_blockly.js"></script>
      
</head>
<body>
  
  <div id="blocklyDiv" class="centerBlocklyDiv"></div>
  <textarea id="blocklyTextId" class="blocklyText"></textarea>
  <div id="gameRight" class="centergame"></div>
  <xml id="toolbox" style="display: none">        
        <category name="movimientos" colour="#a55b6d">
            <block type="move_right"></block>
            <block type="move_left"></block>
            <block type="move_down"></block>
            <block type="move_up"></block>
          </category>
    </xml>
    <xml id="startBlocks" style="display: none">
        </xml>
<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    parent: document.getElementById("gameRight"),
    width: 800,
    height: 480,
    physics: {
        default: 'arcade',
        arcade: {
            //gravity: { y: -300 },
            debug: false
        }
    },  
    scene: {
        preload: preload,
        create: create,
        update: update        
    }
};
// declaro la creacion del juego
var game = new Phaser.Game(config);
var score = "1";
var widthGame = 800;
var hightGame = 480;
// ubicacion sprite al comienzo
var sprite;
//inicia tablero 195 es el valor de height + 5 por un defasaje
var horizontal = widthGame - (( widthGame / 2 ) / 2);
var vertical = hightGame - ((hightGame - (195 + 5)) / 2);
var width = widthGame / 2;
var hight = hightGame - (195 + 5);
var cantCellVertical = 6;
var cantCellHorizontal = 5;
var cellWidth = width / cantCellVertical;
var cellhight = hight / cantCellHorizontal;
// ubicacion sobre el eje Y de los botones que ejecutan las acciones
var posYExecutables = hightGame - (cellhight / 2);
var posXExecutables = cellWidth / 2;
// posicion de sprite de inicio
const initPosX = width + (cellWidth / 2);
const initPosY = hightGame - (cellhight / 2);
// movimiento en tablero
const moveX = cellWidth;
const moveY = cellhight;
// sector botones
var playButton;
var resetButton;

// posicion variale del sprite
var posX;
var posY;
// linea de movimientos animados y avance
var timeline;

// tiempo del sprite para moverse de "a" a "b"
var tiempoSprite = 1000;
// Título de juego terminado
var title;

var titleOutTable;
// Título de juego teminado.
var titleGameComplete;

var cantStars = 1;
var star;
var yo;

inject_blockly();

function preload ()
{
    this.load.image('sky', '../../assets/sky.png');
    this.load.image('play', '../../assets/play.png');
    this.load.image('reset', '../../assets/reset.png');
    this.load.image('menu', '../../assets/menu.png');
    this.load.image('star', '../../assets/star.png');
    this.load.spritesheet('dude', '../../assets/dude.png', { frameWidth: 32, frameHeight: 48 });    
}

function create ()
{    
  yo = this;
    posX = initPosX;
    posY = initPosY;      
    
    this.add.image(400, 300, 'sky');
    
    this.add.grid(horizontal, vertical, width, hight, cellWidth, cellhight, 0xDADADA).setAltFillStyle(0xA5A5A5).setOutlineStyle();

    sprite = this.physics.add.sprite(initPosX, initPosY, 'dude');

    star = this.physics.add.image(initPosX + (moveX * 2), initPosY - (moveY * 2), 'star');

    //colision con el mundo
    sprite.setBounce(0.2);
    sprite.setCollideWorldBounds(true);

    this.physics.add.overlap(sprite, star, collectStar, null, this);

    playButton = this.add.image(posXExecutables, posYExecutables, 'play').setInteractive().setDisplaySize(50,50);
    menuButton = this.add.image((widthGame / 2) - (cellWidth / 2), posYExecutables, 'menu').setInteractive().setDisplaySize(50,50);
    resetButton = this.add.image(posXExecutables + cellWidth, posYExecutables, 'reset').setInteractive().setDisplaySize(50,50);
    resetButton.visible = false;

    timeline = this.tweens.createTimeline();    

    var style = {
        fontSize: '16px',
        fontFamily: 'Arial',
        color: 'white',
        backgroundColor: '#000000'
    };
    var gameOver = "Juego terminado";
    var paddingGameOver = 16;
    title = this.add.text(465, 300, '', style).setPadding(paddingGameOver);
    title.setText(gameOver);
    title.visible = false;  

    titleOutTable = this.add.text(465, 300, '', style).setPadding(paddingGameOver);
    titleOutTable.setText("Juego terminado. Se cayó del tanblero.");
    titleOutTable.visible = false; 
    
    
    
    var style = {
        fontSize: '16px',
        fontFamily: 'Arial',
        color: 'white',
        backgroundColor: '#28B463'
    };
    var gameComplete = "Juego completado";
    var paddingGameComplete = 16;
    titleGameComplete = this.add.text(465, 300, '', style).setPadding(paddingGameComplete);
    titleGameComplete.setText(gameComplete);
    titleGameComplete.visible = false;  
    

    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'dude', frame: 4 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
        frameRate: 10,
        repeat: -1
    });

    playButton.on('pointerdown', function(){                       
            playButton.visible = false;
            resetButton.visible = true;               
            runCode();                                   
    });
    menuButton.on('pointerdown', function(){                                              
      score = "menu";                                 
    });
    resetButton.on('pointerdown', function(){                                  
            resetButton.visible = false;  
            playButton.visible = true;    
            sprite.x = initPosX;
            sprite.y = initPosY;
            posX = initPosX;
            posY = initPosY;     
            title.visible = false;  
            titleOutTable.visible = false;
            titleGameComplete.visible = false;
            sprite.visible = true;       
            cantStars = 1;               
            /* star = yo.physics.add.image(initPosX + (moveX * 2), initPosY - (moveY * 2), 'star');    
            yo.physics.add.overlap(sprite, star, collectStar, null, this); */  
    },this);
}

function spriteRight(){
    timeline.add({
        targets: sprite,        
        x: {
            getEnd: function (sprite, key, value)
            {                                
                posX += moveX;                
                return posX;
            },
            getStart: function (sprite, key, value)
            {                     
                sprite.anims.play('right');                            
                return posX;
            }
        },
        ease: 'Power1',
        duration: tiempoSprite
    });
}

function spriteLeft(){
    
    timeline.add({
        targets: sprite,              
        x: {
            getEnd: function (sprite, key, value)
            {                                
                posX -= moveX;                
                return posX;
            },
            getStart: function (sprite, key, value)
            {          
                sprite.anims.play('left');                      
                return posX;
            }
        },
        ease: 'Power1',
        duration: tiempoSprite
    });
}

function spriteUp(){
    
    timeline.add({
        targets: sprite,              
        y: {
            getEnd: function (sprite, key, value)
            {                                
                posY -= moveY;                
                return posY;
            },
            getStart: function (sprite, key, value)
            {          
                sprite.anims.play('turn');                      
                return posY;
            }
        },
        ease: 'Power1',
        duration: tiempoSprite
    });
}

function spriteDown(){
    
    timeline.add({
        targets: sprite,              
        y: {
            getEnd: function (sprite, key, value)
            {                                
                posY += moveY;                
                return posY;
            },
            getStart: function (sprite, key, value)
            {          
                sprite.anims.play('turn');                      
                return posY;
            }
        },        
        ease: 'Power1',
        duration: tiempoSprite
    });
}

function update ()
{
    if(!timeline.isPlaying()){
        sprite.anims.play('turn'); 
    }
    if(sprite.x > (initPosX + (moveX * 5))){
        console.log("se cayo a la derecha");
        titleOutTable.visible = true;  
        sprite.visible = false;        
    }
    if(sprite.x < initPosX){
        console.log("se cayo a la izq");
        titleOutTable.visible = true;  
        sprite.visible = false;        
    }
    if(sprite.y > initPosY){        
        console.log("se cayo abajo", sprite.y, initPosY);        
        sprite.visible = false;
        titleOutTable.visible = true;            
    }
    if(sprite.y < (initPosY - (moveY * 5)) ){
        console.log("se cayo arriba");   
        titleOutTable.visible = true;     
        sprite.visible = false;        
    }
}

function collectStar (sprite, star)
{
    cantStars--;
    if(cantStars === 0){
        star.disableBody(false, true);        
        titleGameComplete.visible = true;    
    }    
}

</script>
</body>
</html>